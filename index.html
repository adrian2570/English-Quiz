<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>English Quiz with TTS and Voice Options</title>
  <script>
    // Original quiz data remains unchanged
    let quizData = [
      { word: "apple", sentence: "An ____ a day keeps the doctor away.", note: "" },
      { word: "beautiful", sentence: "This park is so ____ in the morning.", note: "" },
      { word: "quickly", sentence: "She ran ____ to catch the bus.", note: "" },
      { word: "strong", sentence: "Exercise makes your body ____.", note: "" },
      { word: "happy", sentence: "I feel ____ when I play with my friends.", note: "" }
    ];

    // Variables to manage quiz state
    let currentQuizData = quizData;
    let incorrectAnswers = [];
    let currentIndex = 0;
    let score = 0;
    let selectedVoice = null; // to store user's selected voice

    // Save, load, and clear progress functions (unchanged)...
    function saveProgress() {
      const progress = {
        quizData: quizData,
        currentQuizData: currentQuizData,
        incorrectAnswers: incorrectAnswers,
        currentIndex: currentIndex,
        score: score
      };
      localStorage.setItem("quizProgress", JSON.stringify(progress));
    }

    function loadProgress() {
      const savedProgress = localStorage.getItem("quizProgress");
      return savedProgress ? JSON.parse(savedProgress) : null;
    }

    function clearProgress() {
      localStorage.removeItem("quizProgress");
    }

    // Start a new quiz session
    function startQuiz(data, resume = false) {
      if (!resume) {
        currentQuizData = data.map(item => ({
          word: item.word,
          fullSentence: item.sentence.replace(/_+/g, item.word),
          sentence: item.sentence,
          hiddenWords: [item.word.toLowerCase()],
          note: item.note || ""
        }));
        currentIndex = 0;
        score = 0;
        incorrectAnswers = [];
        clearProgress();
      } else {
        const progress = loadProgress();
        if (progress) {
          quizData = progress.quizData;
          currentQuizData = progress.currentQuizData;
          incorrectAnswers = progress.incorrectAnswers;
          currentIndex = progress.currentIndex;
          score = progress.score;
        }
      }
      updateUIForQuiz();
      loadQuiz();
    }

    // Update UI for quiz mode
    function updateUIForQuiz() {
      document.getElementById("reviewAllButton").style.display = "none";
      document.getElementById("reviewIncorrectButton").style.display = "none";
      document.getElementById("resumeButton").style.display = "none";
      document.getElementById("startNewButton").style.display = "none";
      document.getElementById("answer").style.display = "inline";
      document.getElementById("checkButton").style.display = "inline";
      document.getElementById("replayButton").style.display = "inline";
      document.getElementById("addNoteButton").style.display = "none";
    }

    // Load the current quiz question
    function loadQuiz() {
      if (currentIndex < currentQuizData.length) {
        let current = currentQuizData[currentIndex];
        document.getElementById("sentence").innerText = current.sentence;
        document.getElementById("noteDisplay").innerText = current.note ? `Note: ${current.note}` : "";
        // TTS reads the full sentence (with the hidden word filled in)
        speakText(current.fullSentence + (current.note ? " Your note: " + current.note : ""));
        document.getElementById("answer").value = "";
        document.getElementById("message").innerText = "";
        document.getElementById("nextButton").style.display = "none";
        document.getElementById("checkButton").style.display = "inline";
        document.getElementById("addNoteButton").style.display = "none";
      } else {
        displaySummary();
      }
      saveProgress();
    }

    // Check the user's answer
    function checkAnswer() {
      let userAnswer = document.getElementById("answer").value.trim().toLowerCase();
      if (!userAnswer) {
        document.getElementById("message").innerText = "Please enter a word!";
        speakText("Please enter a word!");
        return;
      }
      let correctWord = currentQuizData[currentIndex].hiddenWords.join(",").toLowerCase();
      if (userAnswer === correctWord) {
        score++;
        document.getElementById("message").innerHTML = `✅ Correct! Score: ${score}/${currentIndex + 1}`;
        document.getElementById("message").style.color = "green";
        speakText("Correct!");
      } else {
        incorrectAnswers.push({ ...currentQuizData[currentIndex] });
        document.getElementById("message").innerHTML = `❌ Incorrect! The correct answer was: <b>${correctWord}</b>. Score: ${score}/${currentIndex + 1}`;
        document.getElementById("message").style.color = "red";
        speakText(`Incorrect! The correct answer was ${correctWord}`);
      }
      document.getElementById("checkButton").style.display = "none";
      document.getElementById("nextButton").style.display = "inline";
      document.getElementById("addNoteButton").style.display = "inline";
      saveProgress();
    }

    // Move to the next question
    function nextQuestion() {
      currentIndex++;
      loadQuiz();
    }

    // Add a personal note for the current sentence
    function addNote() {
      let note = prompt("Enter your personal note for this sentence:", currentQuizData[currentIndex].note || "");
      if (note !== null) {
        currentQuizData[currentIndex].note = note;
        quizData = quizData.map(item =>
          item.sentence === currentQuizData[currentIndex].sentence ? { ...item, note } : item
        );
        document.getElementById("noteDisplay").innerText = `Note: ${note}`;
        speakText(`Your note: ${note}`);
        saveProgress();
      }
    }

    // Add a new sentence (you enter the full sentence and specify the word(s) to hide)
    function addNewSentence() {
      let fullSentence = prompt("Enter the full sentence (with all words):");
      if (!fullSentence) {
        alert("Please enter a valid sentence.");
        return;
      }
      let hiddenWordsInput = prompt("Enter the word(s) to hide (separated by commas if more than one):");
      if (!hiddenWordsInput) {
        alert("Please enter at least one word to hide.");
        return;
      }
      let hiddenWords = hiddenWordsInput.split(",").map(word => word.trim().toLowerCase());
      // Generate display sentence: for each hidden word, replace it with "____"
      let displaySentence = fullSentence;
      hiddenWords.forEach(word => {
        let regex = new RegExp("\\b" + word + "\\b", "gi");
        displaySentence = displaySentence.replace(regex, "____");
      });
      const newItem = {
        fullSentence: fullSentence,
        sentence: displaySentence,
        hiddenWords: hiddenWords,
        note: ""
      };
      quizData.push(newItem);
      // Add to currentQuizData as well
      if (currentQuizData === quizData) {
        currentQuizData = quizData;
      } else if (currentIndex < currentQuizData.length) {
        currentQuizData.push(newItem);
      }
      document.getElementById("message").innerText = `Added: "${displaySentence}" (Hidden: ${hiddenWords.join(", ")})`;
      speakText(`Added new sentence: ${fullSentence}`);
      saveProgress();
    }

    // Display the quiz summary and review options
    function displaySummary() {
      document.getElementById("sentence").innerText = `Quiz Complete! You got ${score} out of ${currentQuizData.length} correct.`;
      document.getElementById("noteDisplay").innerText = "";
      document.getElementById("answer").style.display = "none";
      document.getElementById("checkButton").style.display = "none";
      document.getElementById("nextButton").style.display = "none";
      document.getElementById("replayButton").style.display = "none";
      document.getElementById("addNoteButton").style.display = "none";
      speakText(`Quiz Complete! You got ${score} out of ${currentQuizData.length} correct.`);
      document.getElementById("reviewAllButton").style.display = "inline";
      if (incorrectAnswers.length > 0) {
        document.getElementById("reviewIncorrectButton").style.display = "inline";
      }
      saveProgress();
    }

    // Review only incorrect words
    function reviewIncorrect() {
      if (incorrectAnswers.length > 0) {
        startQuiz(incorrectAnswers);
      }
    }

    // Replay the current sentence: display version remains with blanks, TTS uses the full sentence.
    function replaySentence() {
      let current = currentQuizData[currentIndex];
      let ttsText = current.fullSentence;
      if (current.note) {
        ttsText += " Your note: " + current.note;
      }
      speakText(ttsText);
    }

    // Speak text using the browser's text-to-speech with cancellation of any ongoing speech
    function speakText(text) {
      if ("speechSynthesis" in window) {
        window.speechSynthesis.cancel();
        let speech = new SpeechSynthesisUtterance(text);
        speech.lang = "en-US";
        // Use selected voice if available
        if(selectedVoice){
          speech.voice = selectedVoice;
        }
        window.speechSynthesis.speak(speech);
      } else {
        console.log("Speech synthesis not supported: " + text);
      }
    }

    // Populate the voice options once voices are loaded
    function populateVoiceList() {
      if(typeof speechSynthesis === 'undefined') return;
      let voices = speechSynthesis.getVoices();
      let voiceSelect = document.getElementById("voiceSelect");
      voiceSelect.innerHTML = "";
      voices.forEach((voice) => {
        let option = document.createElement("option");
        option.value = voice.name;
        option.textContent = `${voice.name} (${voice.lang})`;
        voiceSelect.appendChild(option);
      });
    }

    window.speechSynthesis.onvoiceschanged = populateVoiceList;

    // When user selects a voice from the dropdown, set the selectedVoice variable.
    function setVoice() {
      let voiceName = document.getElementById("voiceSelect").value;
      let voices = window.speechSynthesis.getVoices();
      selectedVoice = voices.find(voice => voice.name === voiceName);
    }

    // Check for saved progress on page load; allow resuming if available.
    window.onload = function() {
      const progress = loadProgress();
      if (progress) {
        quizData = progress.quizData;
        if (progress.currentIndex < progress.currentQuizData.length) {
          document.getElementById("sentence").innerText = "You have saved progress!";
          document.getElementById("resumeButton").style.display = "inline";
          document.getElementById("startNewButton").style.display = "inline";
          document.getElementById("answer").style.display = "none";
          document.getElementById("checkButton").style.display = "none";
          document.getElementById("replayButton").style.display = "none";
          document.getElementById("addNoteButton").style.display = "none";
        } else {
          startQuiz(quizData);
        }
      } else {
        startQuiz(quizData);
      }
    };

    // Allow submitting answers with the Enter key
    document.addEventListener("keypress", function(event) {
      if (event.key === "Enter" && document.getElementById("checkButton").style.display !== "none") {
        checkAnswer();
      }
    });
  </script>
</head>
<body style="font-family: Arial, sans-serif; text-align: center; padding: 20px;">
  <h2>🎤 English Quiz with Text-to-Speech</h2>
  <!-- Voice selection dropdown -->
  <select id="voiceSelect" onchange="setVoice()" style="padding: 8px; font-size: 16px;"></select>
  <p id="sentence" style="font-size: 20px;"></p>
  <p id="noteDisplay" style="font-size: 16px; color: #555;"></p>
  <input type="text" id="answer" placeholder="Type the missing word..." autocorrect="off" spellcheck="false" style="padding: 10px; font-size: 18px;">
  <button id="checkButton" onclick="checkAnswer()" style="padding: 10px; font-size: 18px; margin-left: 10px;">Check</button>
  <button id="nextButton" onclick="nextQuestion()" style="display: none; padding: 10px; font-size: 18px; margin-left: 10px;">Next</button>
  <button id="replayButton" onclick="replaySentence()" style="padding: 10px; font-size: 18px; margin-left: 10px;">Replay</button>
  <button id="addNoteButton" onclick="addNote()" style="display: none; padding: 10px; font-size: 18px; margin-left: 10px;">Add Personal Note</button>
  <p id="message" style="font-size: 18px; font-weight: bold;"></p>
  <button id="addNewSentenceButton" onclick="addNewSentence()" style="padding: 10px; font-size: 18px; margin-top: 20px;">Add New Sentence</button>
  <button id="reviewAllButton" style="display: none; padding: 10px; font-size: 18px; margin-top: 20px;" onclick="startQuiz(quizData)">Review All Words</button>
  <button id="reviewIncorrectButton" style="display: none; padding: 10px; font-size: 18px; margin-top: 20px;" onclick="reviewIncorrect()">Review Incorrect Words</button>
  <br><br>
  <button id="resumeButton" onclick="startQuiz(null, true)" style="display: none; padding: 10px; font-size: 18px; margin-top: 20px;">Resume Quiz</button>
  <button id="startNewButton" onclick="startQuiz(quizData)" style="display: none; padding: 10px; font-size: 18px; margin-top: 20px;">Start New Quiz</button>
</body>
</html>
