<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>English Word Quiz</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 15px;
      background: #f8f9fa;
      color: #333;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
    }
    .card {
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin: 20px 0;
    }
    input {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: 2px solid #ddd;
      border-radius: 10px;
      font-size: 16px;
      box-sizing: border-box;
    }
    button {
      padding: 8px 16px;
      margin: 4px 2px;
      border: 2px solid #ddd;
      border-radius: 10px;
      font-size: 14px;
      background: #1a73e8;
      color: white;
      font-weight: 500;
    }
    #progress {
      height: 4px;
      background: #e9ecef;
      border-radius: 2px;
      margin: 15px 0;
    }
    #progressBar {
      height: 100%;
      background: #1a73e8;
      width: 0%;
      transition: width 0.3s ease;
    }
    #sentence {
      font-size: 1.2em;
      margin: 15px 0;
    }
    #message, #hint {
      margin: 10px 0;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    .correct { color: #34a853; }
    .incorrect { color: #ea4335; }
    .loading { color: #1a73e8; font-weight: 500; }
    .error { color: #d93025; font-weight: 500; }
    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
    }
    #errorModal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.2);
      text-align: center;
      z-index: 1000;
    }
    #errorModal button {
      background: #d93025;
      margin-top: 10px;
    }
    .overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 999;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div id="progress"><div id="progressBar"></div></div>
      <p id="sentence"></p>
      <input type="text" id="answer" placeholder="Type missing word..." autocapitalize="none" aria-label="Answer input">
      <div id="message"></div>
      <div id="hint"></div>
      <div class="button-group">
        <button id="submitButton" onclick="checkAnswer()">Submit</button>
        <button id="helpButton" onclick="toggleHelp()" aria-label="Help options">üîä Help</button>
        <button id="skipButton" onclick="skipQuestion()" aria-label="Skip question">‚è≠Ô∏è Skip</button>
        <button id="audioToggle" onclick="toggleAudio()" aria-label="Toggle audio">üîä On</button>
      </div>
    </div>
  </div>
  <div class="overlay" id="overlay"></div>
  <div id="errorModal">
    <p id="errorMessage"></p>
    <button onclick="reloadPage()">Try Again</button>
  </div>

  <script>
    const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTV27xPm4MU3t9uEkoehyb_LZs176_3yxDOFEedRZqf6vEzoECt8X7yEPsKpMfB9A/pub?output=csv';
    let quizData = [];
    let currentIndex = 0;
    let score = 0;
    let skippedQuestions = [];
    let synth = window.speechSynthesis;
    let googleVoice = null;
    let isMuted = false;
    let helpToggle = 0; // 0 = off, 1 = replay, 2 = hint

    function displayError(message) {
      document.getElementById('errorMessage').textContent = message;
      document.getElementById('errorModal').style.display = 'block';
      document.getElementById('overlay').style.display = 'block';
      document.querySelector('.card').style.display = 'none';
    }

    function reloadPage() {
      location.reload();
    }

    async function loadSheetData(retries = 3, delay = 1000) {
      document.getElementById('sentence').textContent = "Loading quiz...";
      document.getElementById('sentence').classList.add('loading');
      for (let attempt = 1; attempt <= retries; attempt++) {
        try {
          const response = await fetch(SHEET_URL, { cache: 'no-store' });
          if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
          const csvData = await response.text();
          if (!csvData.trim()) throw new Error('Received empty data from sheet');
          const rows = csvData.split('\n').slice(1);
          quizData = rows.map(row => {
            const [word, example] = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
            if (!word || !example) throw new Error(`Invalid row format: ${row}`);
            const regex = new RegExp(`\\b${word.trim()}\\b`, 'gi');
            return { word: word.trim(), sentence: example.trim().replace(regex, '____'), fullSentence: example.trim() };
          }).filter(item => item.word && item.sentence);
          if (quizData.length === 0) throw new Error('No valid quiz data found');
          document.getElementById('sentence').classList.remove('loading');
          startQuiz();
          return;
        } catch (error) {
          console.error(`Attempt ${attempt} failed: ${error.message}`);
          if (attempt === retries) displayError('Oops! We couldn‚Äôt load the quiz. Please check your connection and try again.');
          else await new Promise(resolve => setTimeout(resolve, delay));
        }
      }
    }

    async function setupVoice() {
      try {
        if (!synth) throw new Error('Speech synthesis not supported');
        const voices = await new Promise((resolve, reject) => {
          const timeout = setTimeout(() => reject(new Error('Voices not loaded')), 5000);
          synth.onvoiceschanged = () => { clearTimeout(timeout); resolve(synth.getVoices()); };
          if (synth.getVoices().length) { clearTimeout(timeout); resolve(synth.getVoices()); }
        });
        googleVoice = voices.find(v => v.voiceURI.includes('Google') && v.lang === 'en-US' && v.name.toLowerCase().includes('female')) || voices[0];
        if (!googleVoice) console.warn('No preferred voice found; using default');
      } catch (error) {
        console.warn(`Voice setup failed: ${error.message}. Continuing without speech.`);
        googleVoice = null;
      }
    }

    function startQuiz() {
      currentIndex = 0;
      score = 0;
      skippedQuestions = [];
      updateProgress();
      showNextQuestion();
    }

    function updateProgress() {
      const totalQuestions = quizData.length + skippedQuestions.length;
      const progress = totalQuestions ? (currentIndex / totalQuestions) * 100 : 0;
      document.getElementById('progressBar').style.width = `${progress}%`;
      if (currentIndex < quizData.length) document.getElementById('sentence').textContent = `Question ${currentIndex + 1} of ${totalQuestions}: ${quizData[currentIndex].sentence}`;
    }

    function showNextQuestion() {
      if (!quizData.length) {
        displayError('No quiz data available');
        return;
      }
      if (currentIndex >= quizData.length) {
        if (skippedQuestions.length > 0) {
          quizData = [...skippedQuestions];
          skippedQuestions = [];
          currentIndex = 0;
          updateProgress();
          showNextQuestion();
        } else {
          document.getElementById('sentence').textContent = `üéâ Great job! Your score: ${score}/${quizData.length}`;
          document.getElementBy
