<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>English Word Quiz Enhanced</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 15px;
            background: #f8f9fa;
            color: #333;
            overscroll-behavior: none;
        }
        .container { max-width: 600px; margin: 0 auto; }
        #category-select-card { /* Card for category selection */
            display: none; /* Hide category selection as data source is now a flat list from Google Sheet */
            background: white;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin: 20px 0;
            text-align: center;
        }
        select { /* Category dropdown & Voice select dropdown */
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 16px;
            margin-top: 10px;
            width: 100%; /* Make dropdowns full width in their container */
            box-sizing: border-box; /* Ensure padding is included in width */
            -webkit-appearance: auto; /* Reset to default appearance for consistent styling */
            -moz-appearance: auto;
            appearance: auto;
            background-color: white; /* Ensure white background for dropdowns */
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin: 20px 0;
        }
        input {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            box-sizing: border-box;
        }
        button {
            padding: 10px 20px;
            margin: 6px 4px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            background: #1a73e8;
            color: white;
            font-weight: 500;
            cursor: pointer;
            touch-action: manipulation;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #0e5cb8;
        }
        #progress {
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            margin: 15px 0;
        }
        #progressBar {
            height: 100%;
            background: #1a73e8;
            width: 0%;
            transition: width 0.3s ease;
        }
        #sentence { font-size: 1.2em; margin: 15px 0; }
        #message { margin: 10px 0; font-weight: 500; transition: opacity 0.3s ease; opacity: 1; }
        .correct { color: #34a853; }
        .incorrect { color: #ea4335; }
        .loading { color: #1a73e8; font-weight: 500; }
        .error { color: #ea4335; font-weight: 500; }
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }
        .feedback-animation { /* Animation for feedback messages */
            animation: feedbackFade 1.5s forwards;
            animation-timing-function: ease-out; /* Added easing for smoother fade */
        }
        /* Add a class to disable animation for lower performance devices (optional, could detect via JS too) */
        .no-animation .feedback-animation {
            animation: none !important; /* Disable animation if .no-animation class is present */
            opacity: 0; /* Still make it fade out instantly if animation is disabled, to clear the message */
            transition: opacity 0.5s ease-out; /* Fallback transition for opacity if no animation */
        }
        .help-hint { /* Style for hint messages */
            color: #ffc107; /* Amber color for hints */
            font-style: italic;
        }
        .definition { /* Style for word definition */
            display: none; /* Hide definition display as definition is not in this data source */
            font-size: 0.9em;
            color: #777;
            margin-top: 8px;
            font-style: italic;
        }
        #highScoreDisplay, #quizCountDisplay {
            margin-top: 10px;
            font-weight: bold;
            text-align: center; /* Center align score display */
        }
        #voiceSettings {
            margin-top: 15px;
        }

        #voiceSettings label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        #voiceSelect, #rateControl, #pitchControl {
            margin-bottom: 10px; /* Space between voice settings elements */
        }


        /* Example Media Query for Mobile - Adjust breakpoint and values as needed */
        @media (max-width: 768px) { /* Example breakpoint for smaller screens (tablets and phones) */
            #voiceSettings {
                margin-top: 10px; /* Reduce top margin on smaller screens */
            }

            #voiceSettings label {
                margin-bottom: 3px; /* Slightly reduce label bottom margin */
                font-size: 0.95em; /* Slightly smaller font for labels on mobile if needed */
            }

            #voiceSelect, #rateControl, #pitchControl {
                padding: 8px; /* Slightly reduce padding if needed */
                font-size: 0.9em; /* Smaller font for controls if needed */
            }

            .button-group button { /* Ensure buttons are still tappable and spaced on mobile */
                padding: 8px 16px; /* Adjust button padding if needed */
                margin: 5px 3px;  /* Adjust button margins */
            }
        }


    </style>
</head>
<body class="">
    <div class="container">
        <div id="category-select-card">
            <label for="categorySelect">Choose a category:</label>
            <select id="categorySelect" onchange="selectCategory()">
                <option value="all">All Categories</option>
            </select>
        </div>
        <div class="card">
            <div id="progress"><div id="progressBar"></div></div>
            <p id="sentence"></p>
            <input type="text" id="answer" placeholder="Type missing word..." autocapitalize="none" aria-label="Answer input">
            <div id="message"></div>
            <div class="button-group">
                <button id="submitButton" onclick="checkAnswer()" aria-label="Submit answer">Submit</button>
                <button id="helpButton" onclick="toggleHelp()" aria-label="Help options">🔊 Help</button>
                <button id="audioToggle" onclick="toggleAudio()" aria-label="Toggle audio">🔊 On</button>
            </div>

            <div id="voiceSettings" style="margin-top: 15px;">
                <label for="voiceSelect" style="display: block; margin-bottom: 5px;">Choose Voice:</label>
                <select id="voiceSelect" aria-label="Select voice"></select>

                <label for="rateControl" style="display: block; margin-top: 10px; margin-bottom: 5px;">Speech Rate:</label>
                <input type="range" id="rateControl" min="0.5" max="2" step="0.1" value="0.9" aria-label="Adjust speech rate">

                <label for="pitchControl" style="display: block; margin-top: 10px; margin-bottom: 5px;">Speech Pitch:</label>
                <input type="range" id="pitchControl" min="0" max="2" step="0.1" value="1" aria-label="Adjust speech pitch">
            </div>

            <div id="highScoreDisplay"></div>
            <div id="quizCountDisplay"></div>
        </div>
    </div>

    <script>
        const googleSheetUrl = "YOUR_GOOGLE_SHEET_PUBLISHED_CSV_URL_HERE"; // Your Google Sheet URL - REPLACE THIS!

        let quizData = []; // Will hold the quiz questions
        let currentIndex = 0;
        let score = 0;
        let synth = window.speechSynthesis;
        let googleVoice = null;
        let isMuted = false;
        let helpToggle = 0;
        let lastSpeakTime = 0;
        let currentUtteranceText = ""; // Keep track of currently speaking text
        const CACHE_KEY = 'quizDataCache_v4'; // Versioned cache key for updates
        const CACHE_EXPIRY = 24 * 60 * 60 * 1000; // 24 hours
        const HIGH_SCORE_KEY = 'quizHighScore_v1'; // Key for high score in localStorage
        const QUIZ_COUNT_KEY = 'quizzesTakenCount_v1'; // Key for quiz count
        const VOICE_PREF_KEY = 'preferredVoiceURI_v1'; // Key for preferred voice URI
        const RATE_PREF_KEY = 'preferredSpeechRate_v1'; // Key for preferred speech rate
        const PITCH_PREF_KEY = 'preferredSpeechPitch_v1'; // Key for preferred speech pitch
        let highScore = 0; // Variable to hold current high score (in memory during session)
        let quizCount = 0; // Variable to hold quiz count (in memory)
        let preferredVoiceURI = null; // Variable to hold user's preferred voice URI
        let preferredRate = 0.9;    // Default rate
        let preferredPitch = 1.0;   // Default pitch


        // DOM Elements
        const elements = {
            categorySelect: document.getElementById('categorySelect'), // Still present in HTML but hidden
            sentence: document.getElementById('sentence'),
            answer: document.getElementById('answer'),
            message: document.getElementById('message'),
            progressBar: document.getElementById('progressBar'),
            buttonGroup: document.querySelector('.button-group'),
            helpButton: document.getElementById('helpButton'),
            audioToggle: document.getElementById('audioToggle'),
            voiceSelect: document.getElementById('voiceSelect'),
            rateControl: document.getElementById('rateControl'),
            pitchControl: document.getElementById('pitchControl'),
            voiceSettings: document.getElementById('voiceSettings') // Voice settings container
        };

        // CSV Parser (Adjusted for 2 columns - Word, Sentence)
        function csvToArray(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines.shift().split(','); // Headers are read, but not directly used in object creation now
            return lines.map(line => {
                const values = line.split(',');
                return { // Hardcode property names based on column order (A=word, B=sentence)
                    word: values[0] ? values[0].trim() : '', // Column A (Word)
                    sentence: values[1] ? values[1].trim() : '' // Column B (Sentence)
                };
            });
        }

        // Function to add a "Retry" button if data loading fails
        function addRetryButton() {
            if (!document.getElementById('retryButton')) { // Check if retry button already exists to avoid duplicates
                const retryButton = document.createElement('button');
                retryButton.id = 'retryButton';
                retryButton.textContent = 'Retry Loading Quiz Data';
                retryButton.onclick = loadQuizData; // Re-attempt loading data on click
                retryButton.ariaLabel = 'Retry loading quiz data'; // Accessibility label
                elements.buttonGroup.appendChild(retryButton); // Append to button group
            }
        }


        // Load data from Google Sheet or cache
        async function loadQuizData() {
            elements.sentence.textContent = "Loading quiz data...";
            elements.sentence.classList.add('loading');
            elements.sentence.classList.remove('error'); // Ensure error class is removed

            const cachedData = localStorage.getItem(CACHE_KEY);
            const cacheExpiryTime = localStorage.getItem(`${CACHE_KEY}_expiry`);
            const now = Date.now();

            if (cachedData && cacheExpiryTime && now < parseInt(cacheExpiryTime, 10)) {
                // Valid cached data found and not expired
                console.log('Using cached quiz data.');
                quizData = JSON.parse(cachedData);
                elements.sentence.classList.remove('loading');
                startQuiz(); // Start quiz directly from cache
                return; // Exit function, no need to fetch from Google Sheets
            }

            // If no valid cache, or cache expired, fetch from Google Sheet
            try {
                const response = await fetch(googleSheetUrl);
                if (!response.ok) {
                    let errorMessage = `Failed to load quiz data (HTTP ${response.status}). `;
                    if (response.status === 404) {
                        errorMessage += "Google Sheet not found. Please check your Google Sheet URL.";
                    } else if (response.status >= 500) {
                        errorMessage += "Server error loading Google Sheet. Please try again later.";
                    } else {
                        errorMessage += "Network issue or Google Sheet problem. Please check URL and connection.";
                    }
                    throw new Error(errorMessage); // Throw more informative error
                }
                const csvData = await response.text();
                const parsedData = csvToArray(csvData);

                quizData = parsedData.map(item => ({ // Map CSV data to quizData format
                    word: item.word,
                    sentence: item.sentence,
                    fullSentence: item.sentence,
                    definition: undefined // Definition is not in this sheet, set to undefined
                }));

                if (quizData.length === 0) {
                    elements.sentence.textContent = "No quiz data found in the Google Sheet (or empty sheet).";
                    elements.sentence.classList.remove('loading');
                    elements.sentence.classList.add('error');
                    return;
                }

                // Store fetched data in localStorage with expiry timestamp
                localStorage.setItem(CACHE_KEY, JSON.stringify(quizData));
                localStorage.setItem(`${CACHE_KEY}_expiry`, String(now + CACHE_EXPIRY)); // Save expiry timestamp

                console.log('Fetched new quiz data from Google Sheet and updated cache.');
                elements.sentence.classList.remove('loading');
                startQuiz();

            } catch (error) {
                console.error("Fetching or parsing quiz data error:", error);
                let displayMessage = "Failed to load quiz data."; // Default generic message
                if (error.message.includes('HTTP error')) { // If we threw a more specific HTTP error message
                    displayMessage = error.message; // Use the more specific message
                } else if (error.message.includes('csvToArray')) { // Example of catching a parsing error (if csvToArray throws errors) - adjust if needed
                    displayMessage = "Error parsing data from Google Sheet. Ensure sheet format is correct.";
                } else {
                    displayMessage += " Please check your connection and Google Sheet URL."; // Generic fallback message
                }

                // Check if there's *any* cached data available, even if expired or if fetch fails completely
                if (cachedData) {
                    console.warn('Fetch failed, using potentially outdated cached data.');
                    quizData = JSON.parse(cachedData);
                    elements.sentence.classList.remove('loading');
                    elements.sentence.classList.add('error'); // Indicate potential data issue with error class
                    elements.message.textContent = "Quiz data update failed. Using data from previous load."; // Inform user
                    elements.message.classList.add('help-hint');
                    startQuiz(); // Start quiz from potentially outdated cache
                } else {
                    // If absolutely no data (no cache and fetch failed)
                    elements.sentence.textContent = displayMessage;
                    elements.sentence.classList.remove('loading');
                    elements.sentence.classList.add('error');
                    addRetryButton(); // Add retry button if fetch fails and no cache
                }
            }
        }


        // Voice setup (Modified to populate voice dropdown and load/save preferences)
        async function setupVoice() {
            if (!synth) {
                console.warn('Speech synthesis not supported');
                elements.sentence.textContent = "Speech synthesis is not available in this browser. 😔 Audio playback will be disabled.";
                elements.sentence.classList.remove('loading');
                elements.sentence.classList.add('error');
                elements.audioToggle.style.display = 'none';
                elements.voiceSettings.style.display = 'none'; // Hide voice settings if TTS not supported
                return;
            }

            elements.sentence.textContent = "Loading voice options..."; // Updated message to reflect voice options loading
            elements.sentence.classList.add('loading');

            let voiceCheckTimeout;
            const voices = await new Promise(resolve => {
                let voiceCheckInterval = setInterval(() => {
                    const availableVoices = synth.getVoices();
                    if (availableVoices.length > 0) {
                        clearInterval(voiceCheckInterval);
                        clearTimeout(voiceCheckTimeout);
                        resolve(availableVoices);
                    }
                }, 100);

                voiceCheckTimeout = setTimeout(() => {
                    clearInterval(voiceCheckInterval);
                    resolve(synth.getVoices());
                    console.warn('Voice loading timed out. Using available voices.');
                    elements.message.textContent = "Voice option loading may be slow. Using available voices.";
                    elements.message.classList.add('help-hint');
                }, 3000);
            });

            // Populate voice dropdown
            populateVoiceDropdown(voices); // Call new function to populate dropdown

            // Load preferred voice URI from localStorage
            preferredVoiceURI = localStorage.getItem(VOICE_PREF_KEY);
            preferredRate = parseFloat(localStorage.getItem(RATE_PREF_KEY) || '0.9'); // Load rate, default 0.9
            preferredPitch = parseFloat(localStorage.getItem(PITCH_PREF_KEY) || '1.0'); // Load pitch, default 1.0

            elements.rateControl.value = preferredRate; // Set slider values from preferences
            elements.pitchControl.value = preferredPitch;


            // Prioritized voice selection (now using preferredVoiceURI if set)
            if (preferredVoiceURI) {
                googleVoice = voices.find(v => v.voiceURI === preferredVoiceURI); // Try to use preferred voice
            }
            if (!googleVoice) { // If preferred voice not found or not set, use fallback logic
                googleVoice = voices.find(v => v.voiceURI.includes('Google') && v.lang === 'en-US' && v.name.toLowerCase().includes('female'));
                if (!googleVoice) {
                    googleVoice = voices.find(v => v.lang === 'en-US' && v.name.toLowerCase().includes('female'));
                }
                if (!googleVoice) {
                    googleVoice = voices.find(v => v.voiceURI.includes('Google') && v.lang === 'en-US');
                }
                if (!googleVoice) {
                    googleVoice = voices.find(v => v.lang === 'en-US');
                }
                if (!googleVoice) {
                    googleVoice = voices.find(v => v.name.toLowerCase().includes('female'));
                }
                if (!googleVoice) {
                    googleVoice = voices[0];
                }
            }

            elements.sentence.classList.remove('loading');
            elements.sentence.textContent = "";

            if (!googleVoice) {
                console.warn('No suitable voice found even after timeout.');
                elements.message.textContent = "No suitable voice found. Using default browser voice.";
                elements.message.classList.add('help-hint');
            }
        }

        // New function to populate voice dropdown
        function populateVoiceDropdown(voiceList) {
            elements.voiceSelect.innerHTML = ''; // Clear existing options
            voiceList.forEach(voice => {
                const option = document.createElement('option');
                option.value = voice.voiceURI; // Store voiceURI as value
                option.textContent = `${voice.name} (${voice.lang})`;
                elements.voiceSelect.appendChild(option);
            });

            // Set selected option to preferredVoiceURI if it's valid and in the list
            if (preferredVoiceURI) {
                const validPreferredVoice = voiceList.some(v => v.voiceURI === preferredVoiceURI);
                if (validPreferredVoice) {
                    elements.voiceSelect.value = preferredVoiceURI;
                }
            }
            // Event listener to save voice preference when dropdown changes
            elements.voiceSelect.addEventListener('change', saveVoicePreference);
        }

        // Function to save voice preference to localStorage
        function saveVoicePreference() {
            preferredVoiceURI = elements.voiceSelect.value;
            localStorage.setItem(VOICE_PREF_KEY, preferredVoiceURI);
        }

        // Function to update score display in UI
        function updateScoreDisplay() {
            const highScoreDisplay = document.getElementById('highScoreDisplay');
            const quizCountDisplay = document.getElementById('quizCountDisplay');

            if (highScoreDisplay) {
                highScoreDisplay.textContent = `High Score: ${highScore}`;
            }
            if (quizCountDisplay) {
                quizCountDisplay.textContent = `Quizzes Taken: ${quizCount}`;
            }
        }


        // Quiz functions (mostly same logic, UI updates enhanced) - SAME AS BEFORE
        function startQuiz() {
            currentIndex = 0;
            score = 0;
            elements.answer.style.display = 'block';
            elements.message.style.display = 'block';
            helpToggle = 0;
            elements.helpButton.textContent = '🔊 Help';
            updateUI();
        }

        function updateUI() {
            requestAnimationFrame(() => {
                const progress = quizData.length ? (currentIndex / quizData.length) * 100 : 0;
                if (currentIndex >= quizData.length) {
                    elements.progressBar.style.width = `${progress}%`;
                    elements.sentence.textContent = `🎉 Quiz Completed! Your score: ${score}/${quizData.length}`;
                    elements.answer.style.display = 'none';
                    elements.message.style.display = 'none';
                    elements.buttonGroup.innerHTML = '<button onclick="startQuiz()" aria-label="Restart quiz">Restart Quiz</button>';

                    // Check for high score update and update localStorage
                    if (score > highScore) {
                        highScore = score;
                        localStorage.setItem(HIGH_SCORE_KEY, String(highScore)); // Store new high score
                    }
                    quizCount++; // Increment quiz count
                    localStorage.setItem(QUIZ_COUNT_KEY, String(quizCount)); // Store updated quiz count
                    updateScoreDisplay(); // Update the score display in the UI
                } else {
                    elements.progressBar.style.width = `${progress}%`;
                    elements.sentence.textContent = `Question ${currentIndex + 1} of ${quizData.length}: ${quizData[currentIndex].sentence}`;
                    elements.answer.value = '';
                    elements.message.textContent = '';
                    elements.message.className = 'message';
                    if (!isMuted) speak(quizData[currentIndex].fullSentence);
                    elements.answer.focus();
                }
            });
        }

        // Modify speak function to use preferred voice, rate, and pitch
        function speak(text) {
            if (!synth || !googleVoice || isMuted || Date.now() - lastSpeakTime < 300) return;

            if (text === currentUtteranceText && Date.now() - lastSpeakTime < 1000) {
                return;
            }

            try {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.voice = googleVoice; // Still use googleVoice as fallback if preferred not set/invalid

                // Use preferred rate and pitch from sliders and localStorage
                utterance.rate = parseFloat(elements.rateControl.value);
                utterance.pitch = parseFloat(elements.pitchControl.value);


                synth.cancel();
                synth.speak(utterance);
                lastSpeakTime = Date.now();
                currentUtteranceText = text;
            } catch (error) {
                console.error('Speech synthesis failed:', error);
            }
        }

        // Event listeners for rate and pitch sliders to save preferences
        elements.rateControl.addEventListener('input', saveRatePreference);
        elements.pitchControl.addEventListener('input', savePitchPreference);

        function saveRatePreference() {
            preferredRate = parseFloat(elements.rateControl.value);
            localStorage.setItem(RATE_PREF_KEY, String(preferredRate));
        }

        function savePitchPreference() {
            preferredPitch = parseFloat(elements.pitchControl.value);
            localStorage.setItem(PITCH_PREF_KEY, String(preferredPitch));
        }


        function checkAnswer() {
            const answer = elements.answer.value.trim().toLowerCase();
            if (!answer) {
                elements.message.textContent = "Please enter a word!";
                return;
            }
            const correct = quizData[currentIndex]?.word.toLowerCase();
            if (answer === correct) {
                elements.message.textContent = "✅ Correct! ";
                // Definition is not used/displayed in this version as per request
                elements.message.className = 'message correct feedback-animation';
                score++;
                currentIndex++;
                setTimeout(() => {
                    updateUI();
                }, 1500);
            } else {
                elements.message.textContent = `❌ Incorrect. The word was "${quizData[currentIndex].word}". Try the next one!`;
                elements.message.className = 'message incorrect feedback-animation';
                speak(quizData[currentIndex].fullSentence);
                setTimeout(() => {
                    updateUI();
                }, 1500);
            }
        }

        function toggleHelp() {
            helpToggle = (helpToggle + 1) % 3;
            if (helpToggle === 0) {
                elements.helpButton.textContent = '🔊 Help';
                elements.message.textContent = '';
                elements.message.className = 'message';
            } else if (helpToggle === 1) {
                elements.helpButton.textContent = '🔊 Replay';
                elements.message.textContent = '';
                elements.message.className = 'message';
                if (quizData[currentIndex]) speak(quizData[currentIndex].fullSentence);
            } else if (helpToggle === 2) {
                elements.helpButton.textContent = '💡 Hint';
                if (quizData[currentIndex]) {
                    elements.message.textContent = `Hint: Starts with '${quizData[currentIndex].word[0]}...'`;
                    elements.message.className = 'message help-hint feedback-animation';
                }
            }
        }

        function toggleAudio() {
            isMuted = !isMuted;
            elements.audioToggle.textContent = isMuted ? '🔇 Off' : '🔊 On';
        }

        // Simple (and not very accurate) device performance check - REPLACE with better detection if needed
        const isLowPerformanceDevice = /Android|webOS|iPhone|iPad|iPod|BlackBerry|Opera Mini/i.test(navigator.userAgent) && navigator.deviceMemory <= 2; // Example: Mobile AND low deviceMemory

        if (isLowPerformanceDevice) {
            document.body.classList.add('no-animation'); // Add 'no-animation' class to body to disable animations
            console.log('Low performance device detected. Animations disabled.'); // Log for debugging
        }


        // Initialize
        window.onload = async () => {
            await setupVoice(); // setupVoice now populates dropdown and loads preferences
            loadQuizData();
            highScore = parseInt(localStorage.getItem(HIGH_SCORE_KEY) || '0', 10);
            quizCount = parseInt(localStorage.getItem(QUIZ_COUNT_KEY) || '0', 10);
            updateScoreDisplay();

            // Load preferred rate and pitch on page load from localStorage
            elements.rateControl.value = parseFloat(localStorage.getItem(RATE_PREF_KEY) || '0.9');
            elements.pitchControl.value = parseFloat(localStorage.getItem(PITCH_PREF_KEY) || '1.0');
        };

        // Enter key support
        elements.answer.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') checkAnswer();
        });
    </script>
</body>
</html>
