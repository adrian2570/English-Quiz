<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>English Word Quiz</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 15px;
      background: #f8f9fa;
      color: #333;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
    }
    .card {
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin: 20px 0;
    }
    input {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: 2px solid #ddd;
      border-radius: 10px;
      font-size: 16px;
      box-sizing: border-box;
    }
    #progress {
      height: 4px;
      background: #e9ecef;
      border-radius: 2px;
      margin: 15px 0;
    }
    #progressBar {
      height: 100%;
      background: #1a73e8;
      width: 0%;
      transition: width 0.3s ease;
    }
    #sentence {
      font-size: 1.2em;
      margin: 15px 0;
    }
    #message {
      margin: 10px 0;
      font-weight: 500;
    }
    .error {
      color: #d93025;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div id="progress"><div id="progressBar"></div></div>
      <p id="sentence"></p>
      <input type="text" id="answer" placeholder="Type missing word..." autocapitalize="none">
      <div id="message"></div>
    </div>
  </div>

  <script>
    // Google Sheet configuration
    const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTV27xPm4MU3t9uEkoehyb_LZs176_3yxDOFEedRZqf6vEzoECt8X7yEPsKpMfB9A/pub?output=csv';
    let quizData = [];
    let currentIndex = 0;
    let score = 0;
    let synth = window.speechSynthesis;
    let googleVoice = null;

    // Utility function to display errors
    function displayError(message) {
      const sentenceElement = document.getElementById('sentence');
      sentenceElement.textContent = message;
      sentenceElement.classList.add('error');
      document.getElementById('answer').style.display = 'none';
      console.error(message);
    }

    // Load data from Google Sheet with retry logic
    async function loadSheetData(retries = 3, delay = 1000) {
      for (let attempt = 1; attempt <= retries; attempt++) {
        try {
          const response = await fetch(SHEET_URL, { cache: 'no-store' });
          if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
          const csvData = await response.text();

          if (!csvData.trim()) throw new Error('Received empty data from sheet');

          const rows = csvData.split('\n').slice(1); // Skip header row
          quizData = rows.map(row => {
            const [word, example] = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/); // Handle commas within quoted strings
            if (!word || !example) throw new Error(`Invalid row format: ${row}`);
            const regex = new RegExp(`\\b${word.trim()}\\b`, 'gi');
            return {
              word: word.trim(),
              sentence: example.trim().replace(regex, '____'),
              fullSentence: example.trim()
            };
          }).filter(item => item.word && item.sentence);

          if (quizData.length === 0) throw new Error('No valid quiz data found');
          startQuiz();
          return; // Success, exit retry loop
        } catch (error) {
          console.error(`Attempt ${attempt} failed: ${error.message}`);
          if (attempt === retries) {
            displayError('Failed to load quiz data after multiple attempts. Please check your connection or try again later.');
          } else {
            await new Promise(resolve => setTimeout(resolve, delay)); // Wait before retry
          }
        }
      }
    }

    // Voice setup with fallback
    async function setupVoice() {
      try {
        if (!synth) throw new Error('Speech synthesis not supported in this browser');
        const voices = await new Promise((resolve, reject) => {
          const timeout = setTimeout(() => reject(new Error('Voices not loaded in time')), 5000);
          synth.onvoiceschanged = () => {
            clearTimeout(timeout);
            resolve(synth.getVoices());
          };
          if (synth.getVoices().length) {
            clearTimeout(timeout);
            resolve(synth.getVoices());
          }
        });
        googleVoice = voices.find(v => 
          v.voiceURI.includes('Google') && 
          v.lang === 'en-US' &&
          v.name.toLowerCase().includes('female')
        ) || voices[0];
        if (!googleVoice) console.warn('No preferred voice found; using default');
      } catch (error) {
        console.warn(`Voice setup failed: ${error.message}. Continuing without speech.`);
        googleVoice = null; // Disable speech if setup fails
      }
    }

    // Quiz functions
    function startQuiz() {
      currentIndex = 0;
      score = 0;
      updateProgress();
      showNextQuestion();
    }

    function updateProgress() {
      const progress = quizData.length ? (currentIndex / quizData.length) * 100 : 0;
      document.getElementById('progressBar').style.width = `${progress}%`;
    }

    function showNextQuestion() {
      if (!quizData.length) {
        displayError('No quiz data available');
        return;
      }
      if (currentIndex >= quizData.length) {
        document.getElementById('sentence').textContent = `Quiz Complete! Score: ${score}/${quizData.length}`;
        document.getElementById('answer').style.display = 'none';
        document.getElementById('message').textContent = '';
        return;
      }
      const current = quizData[currentIndex];
      document.getElementById('sentence').textContent = current.sentence;
      speak(current.fullSentence);
      document.getElementById('answer').value = '';
      document.getElementById('message').textContent = '';
      updateProgress();
    }

    function speak(text) {
      if (!synth || !googleVoice) {
        console.log('Speech unavailable: ' + text);
        return;
      }
      try {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.voice = googleVoice;
        utterance.rate = 1.0;
        utterance.onerror = (e) => console.error('Speech error:', e);
        synth.cancel();
        synth.speak(utterance);
      } catch (error) {
        console.error('Speech synthesis failed:', error);
      }
    }

    // Answer checking
    document.getElementById('answer').addEventListener('keypress', e => {
      if (e.key !== 'Enter') return;
      const answer = e.target.value.trim().toLowerCase();
      if (!answer) {
        document.getElementById('message').textContent = "Please enter a word!";
        return;
      }
      const correct = quizData[currentIndex]?.word.toLowerCase();
      if (!correct) {
        console.error('No current question data');
        document.getElementById('message').textContent = "Error: No question data!";
        return;
      }
      if (answer === correct) {
        document.getElementById('message').textContent = "✅ Correct!";
        score++;
        currentIndex++;
        setTimeout(showNextQuestion, 1000);
      } else {
        document.getElementById('message').textContent = "❌ Try again!";
        speak(quizData[currentIndex].fullSentence);
      }
    });

    // Initialize with error handling
    window.onload = async () => {
      try {
        await setupVoice();
        await loadSheetData();
      } catch (error) {
        displayError('Initialization failed. Please reload the page.');
      }
    };
  </script>
</body>
</html>
