<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>English Quiz with TTS</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
    .controls { margin: 20px 0; }
    button, input, select { padding: 10px; margin: 5px; font-size: 16px; }
    #sentence { font-size: 20px; margin: 20px; }
    #message { font-weight: bold; margin: 15px; }
  </style>
</head>
<body>
  <h2>🎤 English Quiz with TTS</h2>
  <select id="voiceSelect" onchange="setVoice()"></select>
  <p id="sentence"></p>
  <p id="noteDisplay"></p>
  
  <div class="controls">
    <input type="text" id="answer" placeholder="Type missing word..." autocorrect="off" spellcheck="false">
    <button id="checkButton" onclick="checkAnswer()">Check</button>
    <button id="nextButton" onclick="nextQuestion()" style="display:none">Next</button>
    <button id="replayButton" onclick="replaySentence()">Replay</button>
    <button id="addNoteButton" onclick="addNote()" style="display:none">Add Note</button>
  </div>

  <p id="message"></p>

  <div class="controls">
    <button id="addNewSentenceButton" onclick="addNewSentence()">Add Sentence</button>
    <button id="reviewAllButton" style="display:none" onclick="startQuiz(quizData)">Review All</button>
    <button id="reviewIncorrectButton" style="display:none" onclick="reviewIncorrect()">Review Mistakes</button>
    <button id="resumeButton" style="display:none" onclick="startQuiz(null, true)">Resume</button>
    <button id="startNewButton" style="display:none" onclick="startQuiz(quizData)">New Quiz</button>
  </div>

  <script>
    let quizData = [], currentQuizData = [], incorrectAnswers = [];
    let currentIndex = 0, score = 0, selectedVoice = null;
    const sheetCSVUrl = 'https://docs.google.com/spreadsheets/d/1DPv_Q__Hb2U88mhK8iDig8LORKH_kU_T/export?format=csv&gid=172221852';

    function loadSentencesFromSheet(callback) {
      Papa.parse(sheetCSVUrl, {
        download: true,
        header: true,
        complete: (results) => {
          const data = results.data.filter(row => row.word && row.example).map(row => ({
            word: row.word.trim(),
            fullSentence: row.example.trim(),
            note: row.note?.trim() || "",
            sentence: row.example.replace(new RegExp("\\b" + row.word.trim() + "\\b", "gi"), "____"),
            hiddenWords: [row.word.trim().toLowerCase()]
          }));
          callback(data);
        },
        error: (err) => console.error("CSV Error:", err)
      });
    }

    function manageProgress(action = 'load') {
      if (action === 'save') {
        localStorage.setItem("quizProgress", JSON.stringify({
          quizData, currentQuizData, incorrectAnswers, currentIndex, score
        }));
      } else {
        const saved = localStorage.getItem("quizProgress");
        return saved ? JSON.parse(saved) : null;
      }
    }

    function startQuiz(data, resume = false) {
      if (resume) {
        const progress = manageProgress();
        if (progress) Object.assign(this, progress);
      } else {
        currentQuizData = data?.map(item => ({...item})) || [];
        currentIndex = score = 0;
        incorrectAnswers = [];
        manageProgress('save');
      }
      updateUI();
      loadQuestion();
    }

    function updateUI(show = ['answer', 'checkButton', 'replayButton']) {
      const elements = ['reviewAllButton', 'reviewIncorrectButton', 'resumeButton', 
        'startNewButton', 'answer', 'checkButton', 'nextButton', 'replayButton', 'addNoteButton'];
      elements.forEach(id => document.getElementById(id).style.display = 
        show.includes(id) ? 'inline' : 'none');
    }

    function loadQuestion() {
      if (currentIndex >= currentQuizData.length) return displaySummary();
      
      const current = currentQuizData[currentIndex];
      document.getElementById("sentence").textContent = current.sentence;
      document.getElementById("noteDisplay").textContent = current.note ? `Note: ${current.note}` : "";
      speakText(current.fullSentence + (current.note ? ` Note: ${current.note}` : ""));
      document.getElementById("answer").value = "";
      document.getElementById("message").textContent = "";
      manageProgress('save');
    }

    function checkAnswer() {
      const userAnswer = document.getElementById("answer").value.trim().toLowerCase();
      const current = currentQuizData[currentIndex];
      
      if (!userAnswer) {
        displayMessage("Please enter a word!", "red");
        return;
      }

      if (userAnswer === current.hiddenWords[0]) {
        score++;
        displayMessage(`✅ Correct! Score: ${score}/${currentIndex + 1}`, "green");
      } else {
        incorrectAnswers.push(current);
        displayMessage(`❌ Incorrect! Correct: ${current.hiddenWords[0]}`, "red");
      }
      updateUI(['answer', 'nextButton', 'replayButton', 'addNoteButton']);
    }

    function displayMessage(text, color) {
      const msg = document.getElementById("message");
      msg.textContent = text;
      msg.style.color = color;
      speakText(text.replace(/[^a-zA-Z ]/g, ''));
    }

    function displaySummary() {
      document.getElementById("sentence").textContent = 
        `Quiz Complete! Score: ${score}/${currentQuizData.length}`;
      updateUI(currentQuizData.length ? ['reviewAllButton'] : []);
      if (incorrectAnswers.length) document.getElementById("reviewIncorrectButton").style.display = 'inline';
    }

    function speakText(text) {
      if (!window.speechSynthesis) return;
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.voice = selectedVoice;
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(utterance);
    }

    function populateVoices() {
      const voices = window.speechSynthesis?.getVoices() || [];
      const select = document.getElementById("voiceSelect");
      select.innerHTML = voices.map(v => 
        `<option value="${v.name}">${v.name} (${v.lang})</option>`
      ).join('');
      selectedVoice = voices[0];
    }

    window.onload = () => {
      populateVoices();
      speechSynthesis.onvoiceschanged = populateVoices;
      
      const progress = manageProgress();
      if (progress?.currentIndex < progress?.currentQuizData.length) {
        updateUI(['resumeButton', 'startNewButton']);
      } else {
        loadSentencesFromSheet(data => startQuiz(data));
      }
    };

    document.addEventListener("keypress", e => {
      if (e.key === "Enter" && document.getElementById("checkButton").style.display !== 'none') checkAnswer();
    });
  </script>
</body>
</html>
